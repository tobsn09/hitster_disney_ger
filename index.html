<!DOCTYPE html>
<html>
<head>
    <title>Disney Hitster Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        body { background-color: #121212; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        .btn { background-color: #1ed760; border: none; padding: 20px 40px; font-size: 20px; font-weight: bold; color: black; border-radius: 50px; cursor: pointer; display: none; margin: 20px auto; width: 80%; max-width: 300px; }
        #status { color: #1ed760; font-size: 18px; margin-top: 20px; font-weight: bold;}
        #reveal-btn { background: transparent; border: 2px solid #555; color: #fff; padding: 15px 30px; border-radius: 30px; display: none; margin: 20px auto; }
        .hidden-info { display: none; margin-top: 20px; }
        img { width: 250px; border-radius: 10px; margin-top: 10px; }
        
        #debug { background-color: #ffffff !important; color: #000000 !important; font-size: 14px !important; margin-top: 30px; text-align: left; padding: 15px; border: 4px solid #ff0000 !important; border-radius: 5px; white-space: pre-wrap; word-break: break-all; font-family: monospace;}
    </style>
</head>
<body>
    <h3 style="margin-top: 10px;">Disney Hitster</h3>
    <p id="status">Lade System...</p>
    
    <button id="login-btn" class="btn">Mit Spotify verbinden</button>
    <button id="play-btn" class="btn">‚ñ∂ PLAY</button>
    <button id="reveal-btn" onclick="reveal()">Aufl√∂sen</button>

    <div id="info" class="hidden-info">
        <h2 id="track-name"></h2>
        <h3 id="artist-name"></h3>
        <img id="album-art" src="" />
    </div>

    <div id="debug">System-Log:<br></div>

    <script>
        function log(msg) {
            document.getElementById('debug').innerHTML += msg + "<br>";
        }

        try {
            log("1. System startet (Clean Version)...");
            const CLIENT_ID = '6959567a76bc4366b778ec6a5b853a91'; 
            
            const AUTH_URL = atob("aHR0cHM6Ly9hY2NvdW50cy5zcG90aWZ5LmNvbS9hdXRob3JpemU=");
            const API_URL = atob("aHR0cHM6Ly9hcGkuc3BvdGlmeS5jb20vdjE=");
            const redirectUri = "https://tobsn09.github.io/hitster_disney_ger/";

            const params = new URLSearchParams(window.location.search);
            let rawTrackId = params.get('track');
            let trackId = null;

            // REINIGUNG: Wir filtern alles raus, was keine saubere ID ist.
            if (rawTrackId) {
                trackId = rawTrackId.split('&')[0].split('?')[0].replace(/[^a-zA-Z0-9]/g, '');
                localStorage.setItem('hitster_track', trackId);
                log("2. NEUE ID sauber gespeichert: " + trackId);
            } else {
                let savedId = localStorage.getItem('hitster_track');
                if (savedId && savedId !== "null") {
                    // Falls noch M√ºll im Speicher ist, putzen wir ihn jetzt weg:
                    trackId = savedId.split('&')[0].split('?')[0].replace(/[^a-zA-Z0-9]/g, '');
                    localStorage.setItem('hitster_track', trackId);
                    log("2. ALTE ID gereinigt & geladen: " + trackId);
                } else {
                    log("2. Keine ID gefunden.");
                }
            }

            let token = localStorage.getItem('hitster_token');
            if (token === "null") token = null;

            let currentHash = window.location.hash.substring(1);

            if (currentHash && currentHash.includes("access_token")) {
                let hashParts = currentHash.split('&');
                for (let i = 0; i < hashParts.length; i++) {
                    let pair = hashParts[i].split('=');
                    if (pair[0] === 'access_token') {
                        token = decodeURIComponent(pair[1]);
                        localStorage.setItem('hitster_token', token); 
                        log("3. Neuer Token gespeichert!");
                    }
                }
                window.history.replaceState(null, null, window.location.pathname + window.location.search);
            }

            if (!token) {
                log("4. Zeige Login-Button...");
                const scopes = 'user-modify-playback-state user-read-playback-state';
                const fullAuthUrl = AUTH_URL + "?client_id=" + CLIENT_ID + "&response_type=token&redirect_uri=" + encodeURIComponent(redirectUri) + "&scope=" + encodeURIComponent(scopes);
                
                document.getElementById('status').innerText = "Bitte anmelden";
                let loginBtn = document.getElementById('login-btn');
                loginBtn.style.display = "inline-block";
                
                loginBtn.onclick = function() {
                    window.location.assign(fullAuthUrl);
                };
            } else {
                log("4. Voll eingeloggt! Bereit.");
                document.getElementById('status').innerText = "Bereit f√ºr Hitster!";
                let playBtn = document.getElementById('play-btn');
                playBtn.style.display = "inline-block";
                
                playBtn.onclick = function() {
                    log("-> PLAY geklickt.");
                    if(!trackId || trackId === "") return alert("Fehler: Keine Song-ID da!");
                    
                    document.getElementById('status').innerText = "Starte Wiedergabe...";
                    playBtn.style.display = "none";
                    
                    log("Sende Anfrage f√ºr Track: " + trackId);
                    
                    fetch(API_URL + "/me/player/play", {
                        method: 'PUT',
                        body: JSON.stringify({ uris: ["spotify:track:" + trackId] }),
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                    }).then(response => {
                        log("Spotify Antwort: " + response.status);
                        
                        if (response.status === 401) {
                            log("Token abgelaufen. Mache Reset...");
                            localStorage.removeItem('hitster_token');
                            location.reload();
                            return;
                        }
                        if (response.status === 400) {
                            log("FEHLER 400: Die Song-ID ist falsch formatiert!");
                            document.getElementById('status').innerText = "Fehler: ID ung√ºltig.";
                            playBtn.style.display = "inline-block";
                            return;
                        }
                        if (response.status === 404 || response.status === 403) {
                            document.getElementById('status').innerText = "Bitte Spotify-App √∂ffnen & Play dr√ºcken!";
                            log("Hinweis: Handy ist nicht das 'aktive Ger√§t' bei Spotify.");
                            playBtn.style.display = "inline-block"; 
                            return;
                        }
                        
                        document.getElementById('status').innerText = "üé∂ Musik l√§uft!";
                        document.getElementById('reveal-btn').style.display = 'inline-block';
                        
                        fetch(API_URL + "/tracks/" + trackId, {
                            headers: {'Authorization': 'Bearer ' + token}
                        })
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById('track-name').innerText = data.name;
                            document.getElementById('artist-name').innerText = data.artists[0].name;
                            document.getElementById('album-art').src = data.album.images[0].url;
                        });
                    }).catch(err => {
                        log("Netzwerkfehler: " + err);
                        playBtn.style.display = "inline-block";
                    });
                };
            }
        } catch (error) {
            log("FEHLER: " + error.message);
        }

        function reveal() {
            document.getElementById('play-btn').style.display = 'none'; 
            document.getElementById('reveal-btn').style.display = 'none'; 
            document.getElementById('status').style.display = 'none'; 
            document.getElementById('info').style.display = 'block';    
        }
    </script>
</body>
</html>
